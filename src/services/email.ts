import { Resend } from 'resend';
import { prisma } from '@/lib/prisma';

interface EmailData {
  to: string;
  subject: string;
  html: string;
  text?: string;
}

interface EmailResponse {
  success: boolean;
  messageId?: string;
  error?: string;
}

class EmailService {
  private resend: Resend | null;

  constructor() {
    // Email service is optional - will work without it but emails will not be sent
    if (process.env.RESEND_API_KEY) {
      this.resend = new Resend(process.env.RESEND_API_KEY);
    } else {
      this.resend = null;
      console.warn('Email service not configured - emails will not be sent');
    }
  }

  async sendEmail({ to, subject, html, text }: EmailData): Promise<EmailResponse> {
    // If email service is not configured, just log and return success
    if (!this.resend) {
      console.log('Email would be sent to:', to, 'Subject:', subject);
      return { success: true, messageId: 'mock-' + Date.now() };
    }

    try {
      const response = await this.resend.emails.send({
        from: process.env.FROM_EMAIL || 'Fitness Scheduler <noreply@fitnessscheduler.com>',
        to: [to],
        subject,
        html,
        text
      });

      // Log the email
      await this.logEmail({
        recipient: to,
        subject,
        message: html,
        status: 'sent',
        externalId: response.data?.id
      });

      return {
        success: true,
        messageId: response.data?.id
      };

    } catch (error: any) {
      console.error('Email send error:', error);

      // Log the error
      await this.logEmail({
        recipient: to,
        subject,
        message: html,
        status: 'failed',
        errorMessage: error.message
      });

      return {
        success: false,
        error: error.message
      };
    }
  }

  private async logEmail(data: {
    recipient: string;
    subject: string;
    message: string;
    status: string;
    externalId?: string;
    errorMessage?: string;
  }) {
    try {
      await prisma.notificationLog.create({
        data: {
          type: 'email',
          recipient: data.recipient,
          subject: data.subject,
          message: data.message,
          status: data.status,
          externalId: data.externalId,
          errorMessage: data.errorMessage
        }
      });
    } catch (error) {
      console.error('Failed to log email:', error);
    }
  }

  // Welcome email template
  generateWelcomeEmail(data: {
    clientName: string;
    loginUrl: string;
    unsubscribeUrl: string;
  }): { html: string; text: string } {
    const html = `
      <!DOCTYPE html>
      <html lang="pt-BR">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Bem-vindo ao Fitness Scheduler</title>
          <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; }
              .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; padding: 2rem; }
              .content { padding: 2rem; }
              .button { display: inline-block; background: #667eea; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; margin: 1rem 0; }
              .footer { background: #f8f9fa; padding: 1rem; text-align: center; font-size: 0.875rem; color: #666; }
              .logo { font-size: 2rem; font-weight: bold; }
          </style>
      </head>
      <body>
          <div class="header">
              <div class="logo">üí™ Fitness Scheduler</div>
              <h1>Bem-vindo, ${data.clientName}!</h1>
          </div>
          
          <div class="content">
              <h2>üéâ Sua conta foi criada com sucesso!</h2>
              
              <p>Estamos muito felizes em t√™-lo conosco! Com o Fitness Scheduler, voc√™ pode:</p>
              
              <ul>
                  <li>üóìÔ∏è Agendar treinos facilmente</li>
                  <li>üí¨ Conversar diretamente com seus instrutores</li>
                  <li>üìä Acompanhar seu progresso</li>
                  <li>üí≥ Gerenciar pagamentos de forma segura</li>
                  <li>‚è∞ Receber lembretes autom√°ticos</li>
              </ul>
              
              <p>Para come√ßar sua jornada fitness, acesse sua conta:</p>
              
              <a href="${data.loginUrl}" class="button">Acessar Minha Conta</a>
              
              <h3>üì± Dicas para aproveitar ao m√°ximo:</h3>
              <ul>
                  <li>Complete seu perfil com suas metas e hist√≥rico m√©dico</li>
                  <li>Explore os diferentes servi√ßos dispon√≠veis</li>
                  <li>Configure suas prefer√™ncias de notifica√ß√£o</li>
                  <li>Agende seu primeiro treino!</li>
              </ul>
              
              <p>Se tiver qualquer d√∫vida, nossa equipe est√° sempre dispon√≠vel para ajudar.</p>
              
              <p><strong>Vamos come√ßar essa jornada juntos! üí™</strong></p>
          </div>
          
          <div class="footer">
              <p>Este email foi enviado para voc√™ porque criou uma conta no Fitness Scheduler.</p>
              <p>Se n√£o deseja mais receber emails, <a href="${data.unsubscribeUrl}">clique aqui</a>.</p>
              <p>&copy; 2025 Fitness Scheduler. Todos os direitos reservados.</p>
          </div>
      </body>
      </html>
    `;

    const text = `
      Bem-vindo ao Fitness Scheduler, ${data.clientName}!
      
      Sua conta foi criada com sucesso!
      
      Com o Fitness Scheduler, voc√™ pode:
      - Agendar treinos facilmente
      - Conversar diretamente com seus instrutores
      - Acompanhar seu progresso
      - Gerenciar pagamentos de forma segura
      - Receber lembretes autom√°ticos
      
      Acesse sua conta: ${data.loginUrl}
      
      Dicas para come√ßar:
      - Complete seu perfil com suas metas
      - Explore os servi√ßos dispon√≠veis
      - Configure suas notifica√ß√µes
      - Agende seu primeiro treino!
      
      Vamos come√ßar essa jornada juntos!
      
      Para cancelar o recebimento destes emails: ${data.unsubscribeUrl}
    `;

    return { html, text };
  }

  // Appointment confirmation email template
  generateAppointmentConfirmationEmail(data: {
    clientName: string;
    trainerName: string;
    serviceName: string;
    date: string;
    time: string;
    location: string;
    price: string;
    appointmentUrl: string;
    unsubscribeUrl: string;
  }): { html: string; text: string } {
    const html = `
      <!DOCTYPE html>
      <html lang="pt-BR">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Agendamento Confirmado</title>
          <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; }
              .header { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; text-align: center; padding: 2rem; }
              .content { padding: 2rem; }
              .appointment-card { background: #f8f9fa; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #10b981; margin: 1rem 0; }
              .button { display: inline-block; background: #10b981; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; margin: 1rem 0; }
              .footer { background: #f8f9fa; padding: 1rem; text-align: center; font-size: 0.875rem; color: #666; }
              .highlight { color: #10b981; font-weight: bold; }
          </style>
      </head>
      <body>
          <div class="header">
              <h1>‚úÖ Agendamento Confirmado!</h1>
          </div>
          
          <div class="content">
              <p>Ol√° <strong>${data.clientName}</strong>,</p>
              
              <p>Seu treino foi confirmado com sucesso! Aqui est√£o os detalhes:</p>
              
              <div class="appointment-card">
                  <h3>üìÖ Detalhes do Agendamento</h3>
                  <p><strong>Servi√ßo:</strong> ${data.serviceName}</p>
                  <p><strong>Instrutor:</strong> ${data.trainerName}</p>
                  <p><strong>Data:</strong> <span class="highlight">${data.date}</span></p>
                  <p><strong>Hor√°rio:</strong> <span class="highlight">${data.time}</span></p>
                  <p><strong>Local:</strong> ${data.location}</p>
                  <p><strong>Valor:</strong> <span class="highlight">R$ ${data.price}</span></p>
              </div>
              
              <h3>üìù Prepara√ß√£o para o Treino:</h3>
              <ul>
                  <li>Chegue 10 minutos antes do hor√°rio</li>
                  <li>Traga roupas confort√°veis para exerc√≠cios</li>
                  <li>N√£o se esque√ßa da toalha e garrafa d'√°gua</li>
                  <li>Informe sobre qualquer problema de sa√∫de</li>
              </ul>
              
              <p>Para ver mais detalhes ou fazer altera√ß√µes:</p>
              <a href="${data.appointmentUrl}" class="button">Ver Agendamento</a>
              
              <p><strong>ü§ù Pol√≠tica de Cancelamento:</strong><br>
              Cancelamentos podem ser feitos at√© 2 horas antes do hor√°rio agendado sem cobran√ßa.</p>
              
              <p>Estamos ansiosos para seu treino! üí™</p>
          </div>
          
          <div class="footer">
              <p>Fitness Scheduler - Sua jornada fitness come√ßa aqui!</p>
              <p><a href="${data.unsubscribeUrl}">Cancelar recebimento de emails</a></p>
          </div>
      </body>
      </html>
    `;

    const text = `
      Agendamento Confirmado!
      
      Ol√° ${data.clientName},
      
      Seu treino foi confirmado:
      
      Servi√ßo: ${data.serviceName}
      Instrutor: ${data.trainerName}
      Data: ${data.date}
      Hor√°rio: ${data.time}
      Local: ${data.location}
      Valor: R$ ${data.price}
      
      Prepara√ß√£o:
      - Chegue 10 minutos antes
      - Traga roupas confort√°veis
      - Toalha e garrafa d'√°gua
      - Informe problemas de sa√∫de
      
      Ver detalhes: ${data.appointmentUrl}
      
      Pol√≠tica: Cancelamentos at√© 2h antes sem cobran√ßa.
      
      Para cancelar emails: ${data.unsubscribeUrl}
    `;

    return { html, text };
  }

  // Reminder email template
  generateReminderEmail(data: {
    clientName: string;
    trainerName: string;
    serviceName: string;
    date: string;
    time: string;
    location: string;
    appointmentUrl: string;
    hours: number;
    unsubscribeUrl: string;
  }): { html: string; text: string } {
    const isNextDay = data.hours >= 24;
    const timeText = isNextDay ? 'amanh√£' : `em ${data.hours}h`;
    
    const html = `
      <!DOCTYPE html>
      <html lang="pt-BR">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Lembrete de Treino</title>
          <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; }
              .header { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; text-align: center; padding: 2rem; }
              .content { padding: 2rem; }
              .reminder-card { background: #fef3c7; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #f59e0b; margin: 1rem 0; }
              .button { display: inline-block; background: #f59e0b; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; margin: 1rem 0; }
              .footer { background: #f8f9fa; padding: 1rem; text-align: center; font-size: 0.875rem; color: #666; }
              .highlight { color: #d97706; font-weight: bold; }
          </style>
      </head>
      <body>
          <div class="header">
              <h1>‚è∞ Lembrete de Treino!</h1>
          </div>
          
          <div class="content">
              <p>Ol√° <strong>${data.clientName}</strong>,</p>
              
              <p>N√£o se esque√ßa! Voc√™ tem um treino agendado <strong>${timeText}</strong>:</p>
              
              <div class="reminder-card">
                  <h3>üèãÔ∏è Detalhes do Treino</h3>
                  <p><strong>Servi√ßo:</strong> ${data.serviceName}</p>
                  <p><strong>Instrutor:</strong> ${data.trainerName}</p>
                  <p><strong>Data:</strong> <span class="highlight">${data.date}</span></p>
                  <p><strong>Hor√°rio:</strong> <span class="highlight">${data.time}</span></p>
                  <p><strong>Local:</strong> ${data.location}</p>
              </div>
              
              ${isNextDay ? `
              <h3>üìã Checklist para Amanh√£:</h3>
              <ul>
                  <li>‚òëÔ∏è Separar roupas de treino</li>
                  <li>‚òëÔ∏è Preparar mochila com toalha e √°gua</li>
                  <li>‚òëÔ∏è Confirmar transporte</li>
                  <li>‚òëÔ∏è Ter uma boa noite de sono</li>
              </ul>
              ` : `
              <h3>‚ö° Prepara√ß√£o R√°pida:</h3>
              <ul>
                  <li>üèÉ‚Äç‚ôÇÔ∏è Vista suas roupas de treino</li>
                  <li>üíß Pegue sua garrafa d'√°gua</li>
                  <li>üèÉ‚Äç‚ôÇÔ∏è Saia de casa com anteced√™ncia</li>
              </ul>
              `}
              
              <a href="${data.appointmentUrl}" class="button">Ver Detalhes Completos</a>
              
              <p><strong>Precisa cancelar?</strong> Fa√ßa isso com pelo menos 2 horas de anteced√™ncia.</p>
              
              <p>Nos vemos ${timeText}! üí™</p>
          </div>
          
          <div class="footer">
              <p>Fitness Scheduler - Mantendo voc√™ motivado!</p>
              <p><a href="${data.unsubscribeUrl}">Cancelar lembretes</a></p>
          </div>
      </body>
      </html>
    `;

    const text = `
      Lembrete de Treino!
      
      Ol√° ${data.clientName},
      
      Voc√™ tem treino ${timeText}:
      
      ${data.serviceName}
      ${data.trainerName}
      ${data.date} √†s ${data.time}
      Local: ${data.location}
      
      ${isNextDay ? 'Prepare-se hoje √† noite!' : 'Prepare-se agora!'}
      
      Ver detalhes: ${data.appointmentUrl}
      
      Cancelamentos at√© 2h antes.
      
      Para cancelar lembretes: ${data.unsubscribeUrl}
    `;

    return { html, text };
  }

  // Quick send methods
  async sendWelcomeEmail(email: string, clientName: string) {
    const loginUrl = `${process.env.NEXT_PUBLIC_APP_URL}/login`;
    const unsubscribeUrl = `${process.env.NEXT_PUBLIC_APP_URL}/unsubscribe`;
    
    const { html, text } = this.generateWelcomeEmail({
      clientName,
      loginUrl,
      unsubscribeUrl
    });

    return this.sendEmail({
      to: email,
      subject: 'üéâ Bem-vindo ao Fitness Scheduler!',
      html,
      text
    });
  }

  async sendAppointmentConfirmation(
    email: string,
    data: {
      clientName: string;
      trainerName: string;
      serviceName: string;
      date: string;
      time: string;
      location: string;
      price: string;
      appointmentId: string;
    }
  ) {
    const appointmentUrl = `${process.env.NEXT_PUBLIC_APP_URL}/appointments/${data.appointmentId}`;
    const unsubscribeUrl = `${process.env.NEXT_PUBLIC_APP_URL}/unsubscribe`;
    
    const { html, text } = this.generateAppointmentConfirmationEmail({
      ...data,
      appointmentUrl,
      unsubscribeUrl
    });

    return this.sendEmail({
      to: email,
      subject: '‚úÖ Agendamento Confirmado - Fitness Scheduler',
      html,
      text
    });
  }

  async sendReminder(
    email: string,
    data: {
      clientName: string;
      trainerName: string;
      serviceName: string;
      date: string;
      time: string;
      location: string;
      appointmentId: string;
      hours: number;
    }
  ) {
    const appointmentUrl = `${process.env.NEXT_PUBLIC_APP_URL}/appointments/${data.appointmentId}`;
    const unsubscribeUrl = `${process.env.NEXT_PUBLIC_APP_URL}/unsubscribe`;
    
    const { html, text } = this.generateReminderEmail({
      ...data,
      appointmentUrl,
      unsubscribeUrl
    });

    const subject = data.hours >= 24 
      ? '‚è∞ Lembrete: Treino Amanh√£ - Fitness Scheduler'
      : `‚è∞ Lembrete: Treino em ${data.hours}h - Fitness Scheduler`;

    return this.sendEmail({
      to: email,
      subject,
      html,
      text
    });
  }
}

export const emailService = new EmailService();